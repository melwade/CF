<? 
ob_start(); // Initiate the output buffer
session_start();
include('content.php');
?>
<!DOCTYPE html>
<html class="html">
 <head>
 

  <meta http-equiv="Content-type" content="text/html;charset=UTF-8"/>
  <meta name="generator" content="7.2.232.244"/>
  <title>Password Reset</title>
  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="css/site_global.css?272710960"/>
  <link rel="stylesheet" type="text/css" href="css/master_a-master.css?4059369144"/>
  <link rel="stylesheet" type="text/css" href="cf_style.css" id="pagesheet"/>
  <!-- Other scripts -->
  <script type="text/javascript">
   document.documentElement.className += ' js';
</script>
<script type="text/javascript" src='message.js'></script>
<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>


<link rel="stylesheet" type="text/css" href="message_default.css">
<link rel="stylesheet" type="text/css" href="styles/style.css">

 <link rel="stylesheet" type="text/css" href="member_tools_style.css" />
</head>
<? include('CF_header.php'); ?>
      <!-- content -->
      <h1 class="Heading-1" style="margin-bottom:30px;">Password Reset</h1>
      
      <?php
//Check if Post.  If so, process request. If not, show reset form
  if(isset($_POST['submit'])) {
$myusername=$_POST['myusername'];
include ('connect.php');
$myusername = stripslashes($myusername);
$myusername = mysql_real_escape_string($myusername);
$sql="SELECT * FROM tblUserData WHERE email_add = '$myusername'";
     
	$result=mysql_query($sql);
	
	// Mysql_num_row is counting table row
	$count=mysql_num_rows($result);
	
	if (($count<>1) || ($myusername=="")) {
		echo "<p class='failed_login_message'>Invalid email address entered</p>";
		displayPasswordReset(); }	
	else {	//Valid username entereed.  Allow password reset.
	//Gather data to be inserted into table
	
	//Email
	$userinfo = "SELECT * from tblUserData WHERE email_add = '$myusername'";
	$rRow = mysql_fetch_array(mysql_query($userinfo)); 
	$user_email = $rRow['email_add'];
	$user_username = $rRow['account_id'];
	$user_fullname = $rRow['fname']. " " . $rRow['lname'];
	$ip_add = $_SERVER["REMOTE_ADDR"];

	//Link Expiration Date
	$todayDate = date("Y-m-d");// current date
	$expire_date = date('Y-m-d', strtotime(date("Y-m-d", strtotime($todayDate)) . " +3 days"));
	
	//Temporary Password
    $temp_pass = genPassword(7);
	
	//Generate Reset Code that is attached to link as an ID
	$reset_code = genPassword(20);
	
	//Remove any existing records for attempted password resets
	mysql_query("DELETE FROM tblResets WHERE email = '$myusername'") or die(mysql_error());
	
	//Insert record in tblResets
	$insert_query="insert into tblResets (account_id, email, expire_date, temp_pw, reset_code) values ('$user_username', '$user_email', '$expire_date', '$temp_pass', '$reset_code')";
	$result = mysql_query($insert_query) or die('Error inserting record: ' . mysql_error());
	
	//Send email with reset info
	send_password_reset($user_email, $temp_pass, $reset_code, $ip_add);
	send_password_reset_admin($user_fullname, $user_email, $ip_add);
	record_user_action($user_email, $ip_add, "Password Reset");
	
echo "<p>An email has been sent to your email address on file.  You should receive the email within the next 30 minutes with instructions on how to reset your password.</p>";

 }
  }
  else {
displayPasswordReset(); }
?>
      
      <a class="anchor_item grpelem" id="thequestion"></a> </div>
    <div class="verticalspacer"></div>
    <div class="clearfix colelem" id="u1130"><!-- group -->
     <div class="clearfix grpelem" id="u6597-4"><!-- content -->
      <p>Â© 2013 Cycle Folsom | Site Design by Stan Schultz</p>
     </div>
     <div class="clearfix grpelem" id="u6598-7"><!-- content -->
      <p>Special thanks to longtime CF member Carl Costas for contributing many of the professional photos on this site. See Carl's work at <a class="nonblock" href="http://www.carlcostas.com" target="_blank">CarlCostas.com</a>.</p>
     </div>
    </div>
   </div>
  </div>
  <!-- JS includes -->
  <script type="text/javascript">
   if (document.location.protocol != 'https:') document.write('\x3Cscript src="http://musecdn2.businesscatalyst.com/scripts/4.0/jquery-1.8.3.min.js" type="text/javascript">\x3C/script>');
</script>
  <script type="text/javascript">
   window.jQuery || document.write('\x3Cscript src="scripts/jquery-1.8.3.min.js" type="text/javascript">\x3C/script>');
</script>
  <script src="scripts/museutils.js?3880880085" type="text/javascript"></script>
  <script src="scripts/jquery.tobrowserwidth.js?152985095" type="text/javascript"></script>
  <script src="scripts/jquery.musemenu.js?32367222" type="text/javascript"></script>
  <script src="scripts/webpro.js?33264525" type="text/javascript"></script>
  <script src="scripts/musewpdisclosure.js?250538392" type="text/javascript"></script>
  <script src="scripts/jquery.watch.js?4199601726" type="text/javascript"></script>
  <!-- Other scripts -->
  <script type="text/javascript">
   $(document).ready(function() { try {
Muse.Utils.transformMarkupToFixBrowserProblemsPreInit();/* body */
$('.browser_width').toBrowserWidth();/* browser width elements */
Muse.Utils.prepHyperlinks(false);/* body */
Muse.Utils.initWidget('.MenuBar', function(elem) { return $(elem).museMenu(); });/* unifiedNavBar */
Muse.Utils.initWidget('#accordionu15508', function(elem) { return new WebPro.Widget.Accordion(elem, {canCloseAll:true,defaultIndex:-1}); });/* #accordionu15508 */
Muse.Utils.fullPage('#page');/* 100% height page */
Muse.Utils.showWidgetsWhenReady();/* body */
Muse.Utils.transformMarkupToFixBrowserProblems();/* body */
} catch(e) { Muse.Assert.fail('Error calling selector function:' + e); }});
</script>
   </body>
</html>
